#include <sa2b/core.h>
#include <sa2b/memory.h>
#include <sa2b/memutil.h>
#include <sa2b/funchook.h>

/** Ninja **/
#include <sa2b/ninja/ninja.h>

/** Source **/
#include <sa2b/src/task.h>
#include <sa2b/src/camera.h>
#include <sa2b/src/njctrl.h>
#include <sa2b/src/debug.h>

/** Render Fix **/
#include <rf_file.h>
#include <rf_draw.h>

#define GET_CARTWK(_tp)     ((CARTWK*)_tp->mwp)

typedef struct
{
    char gap0[8];
    Angle3 ang;
    NJS_POINT3 pos;
    char gap2[20];
    NJS_CNK_OBJECT* pObject;
    NJS_CNK_OBJECT* pFarObject;
    char gap3[12];
    int character;
    char gap4[28];
    Angle angSlide;
    char gap5[132];
    Angle3 ang3;
    Angle3 ang2;
    char gap6[412];
    void* texp;
    int address_u;
    int address_v;
    int tes5;
    int min_filter;
    int mag_filter;
    int bank;
    __int32 stencil_data[1];
    void* stencil_tex;
    char gap7[28];
}
CARTWK;

Sint32 vertex_001907BC[] = { 0xAC0022, 0x390000, 0xC114A3D8u, 0x3DCCCCAF, 0x3F8E147A, 0xC114A3D8u, 0x3DCCCCAF, 0xBF9851F0u, 0xC0C00005u, 0x3DCCCCAF, 0x4040B781, 0xC0C00005u, 0x3DCCCCAF, 0xC04381E1u, 0x4016665E, 0x3DCCCCAF, 0x4040B781, 0x40C61476, 0x3DCCCCAF, 0x3F8E147A, 0x40C61476, 0x3DCCCCAF, 0xBF9851F0u, 0x4016665E, 0x3DCCCCAF, 0xC04381E1u, 0x3F0F5BF4, 0x3DCCCCAF, 0xC0A6B853u, 0x3E8F5BC0, 0x3DCCCCAF, 0xC047AE15u, 0x40F0A3D0, 0x3DCCCCAF, 0xC097B719u, 0x40F0A3D0, 0x3DCCCCAF, 0xC047AE15u, 0x3F0F5BF4, 0x3DCCCCAF, 0x40A6B853, 0x3E8F5BC0, 0x3DCCCCAF, 0x4047AE15, 0x40F0A3D0, 0x3DCCCCAF, 0x4097B719, 0x40F0A3D0, 0x3DCCCCAF, 0x4047AE15, 0xBFBC28F3u, 0xC2200000u, 0x0, 0x3FCCCC96, 0xC21F999Eu, 0xC083332Fu, 0x3FCCCC96, 0xC21F999Eu, 0x40875C28, 0xC088A3E5u, 0xC21F999Eu, 0xC083332Fu, 0xC088A3E5u, 0xC21F999Eu, 0xC083332Fu, 0xC129EB85u, 0x3DCCCCAF, 0xC047AE15u, 0xC129EB85u, 0x3DCCCCAF, 0xC0A6B853u, 0xC088A3E5u, 0xC21F999Eu, 0xC083332Fu, 0xC088A3E5u, 0xC21F999Eu, 0xC083332Fu, 0xC088A3E5u, 0xC21F999Eu, 0xC083332Fu, 0xC071EB84u, 0x3DCCCCAF, 0xC047AE15u, 0xC0B63D74u, 0x3DCCCCAF, 0xC047AE15u, 0xC088A3E5u, 0xC21F999Eu, 0xC083332Fu, 0xC088A3E5u, 0xC21F999Eu, 0xC083332Fu, 0xC071EB84u, 0x3DCCCCAF, 0xC09961E5u, 0xC088A3E5u, 0xC21F999Eu, 0xC083332Fu, 0xC088A3E5u, 0xC21F999Eu, 0xC083332Fu, 0xC0B63D74u, 0x3DCCCCAF, 0xC0A00D1Cu, 0xC088A3E5u, 0xC21F999Eu, 0x40875C28, 0xC088A3E5u, 0xC21F999Eu, 0x40875C28, 0xC071EB84u, 0x3DCCCCAF, 0x4047AE15, 0xC071EB84u, 0x3DCCCCAF, 0x409961E5, 0xC088A3E5u, 0xC21F999Eu, 0x40875C28, 0xC088A3E5u, 0xC21F999Eu, 0x40875C28, 0xC088A3E5u, 0xC21F999Eu, 0x40875C28, 0xC088A3E5u, 0xC21F999Eu, 0x40875C28, 0xC088A3E5u, 0xC21F999Eu, 0x40875C28, 0xC129EB85u, 0x3DCCCCAF, 0x40A6B853, 0xC129EB85u, 0x3DCCCCAF, 0x4047AE15, 0xC088A3E5u, 0xC21F999Eu, 0x40875C28, 0xC0B63D74u, 0x3DCCCCAF, 0x40A00D1C, 0xC088A3E5u, 0xC21F999Eu, 0x40875C28, 0xC0B63D74u, 0x3DCCCCAF, 0x4047AE15, 0xC088A3E5u, 0xC21F999Eu, 0xC083332Fu, 0xC094A3D8u, 0x3DCCCCAF, 0xC0EF175Cu, 0xC088A3E5u, 0xC21F999Eu, 0xC083332Fu, 0xC071EB84u, 0x3DCCCCAF, 0xC0E86C25u, 0xC088A3E5u, 0xC21F999Eu, 0x40875C28, 0xC088A3E5u, 0xC21F999Eu, 0x40875C28, 0xC094A3D8u, 0x3DCCCCAF, 0x40EF1758, 0xC071EB84u, 0x3DCCCCAF, 0x40E86C21, 0xFF, 0x0 };

Sint16 poly_0019057C[] = { 0x38, 0x11B, 0x5E, 0xE, 0xF, 0xC, 0xF, 0xD, 0xC, 0xE, 0xC, 0x12, 0xF, 0xE, 0x12, 0xD, 0xF, 0x12, 0xC, 0xD, 0x12, 0x8, 0x9, 0xA, 0x9, 0xB, 0xA, 0x10, 0x0, 0x1, 0x2, 0x0, 0x10, 0x3, 0x10, 0x1, 0x11, 0x8, 0xA, 0x2, 0x3, 0x0, 0x3, 0x1, 0x0, 0x4, 0x10, 0x5, 0x4, 0x2, 0x10, 0x10, 0x6, 0x5, 0x7, 0x6, 0x10, 0x7, 0x10, 0x3, 0x11, 0xA, 0xB, 0x11, 0xB, 0x9, 0x7, 0x4, 0x6, 0x4, 0x5, 0x6, 0x4, 0x7, 0x2, 0x7, 0x3, 0x2, 0x11, 0x9, 0x8, 0x13, 0x14, 0x16, 0x14, 0x15, 0x16, 0x14, 0x13, 0x17, 0x18, 0x19, 0x1B, 0x19, 0x1A, 0x1B, 0x19, 0x18, 0x1C, 0x14, 0x18, 0x15, 0x18, 0x1B, 0x15, 0x18, 0x14, 0x1C, 0x14, 0x17, 0x1C, 0x19, 0x1D, 0x1A, 0x1D, 0x1E, 0x1A, 0x1D, 0x19, 0x1F, 0x19, 0x1C, 0x1F, 0x1F, 0x1C, 0x17, 0x33, 0x31, 0x34, 0x31, 0x32, 0x34, 0x20, 0x1D, 0x1F, 0x20, 0x13, 0x21, 0x13, 0x16, 0x21, 0x13, 0x20, 0x17, 0x20, 0x1F, 0x17, 0x22, 0x23, 0x25, 0x23, 0x24, 0x25, 0x23, 0x22, 0x27, 0x22, 0x26, 0x27, 0x27, 0x26, 0x28, 0x21, 0x1B, 0x1E, 0x1B, 0x1A, 0x1E, 0x1B, 0x21, 0x15, 0x21, 0x16, 0x15, 0x29, 0x2A, 0x2C, 0x2A, 0x2B, 0x2C, 0x2A, 0x29, 0x28, 0x35, 0x36, 0x37, 0x36, 0x38, 0x37, 0x22, 0x2D, 0x26, 0x2A, 0x2D, 0x2B, 0x2D, 0x2E, 0x2B, 0x2D, 0x2A, 0x26, 0x2A, 0x28, 0x26, 0x23, 0x2F, 0x24, 0x2F, 0x30, 0x24, 0x2F, 0x23, 0x27, 0x2F, 0x29, 0x30, 0x29, 0x2C, 0x30, 0x29, 0x2F, 0x28, 0x2F, 0x27, 0x28, 0x30, 0x2E, 0x24, 0x2E, 0x25, 0x24, 0x2E, 0x30, 0x2B, 0x30, 0x2C, 0x2B, 0x20, 0x21, 0x31, 0x21, 0x32, 0x31, 0x1D, 0x20, 0x33, 0x20, 0x31, 0x33, 0x21, 0x1E, 0x32, 0x1E, 0x34, 0x32, 0x1E, 0x1D, 0x34, 0x1D, 0x33, 0x34, 0x2D, 0x22, 0x35, 0x22, 0x36, 0x35, 0x2E, 0x2D, 0x37, 0x2D, 0x35, 0x37, 0x25, 0x2E, 0x38, 0x2E, 0x37, 0x38, 0x22, 0x25, 0x36, 0x25, 0x38, 0x36, 0xFF };

NJS_CNK_MODEL attach_00190A74 = { vertex_001907BC, poly_0019057C, { -1.550002f, -19.95f, -0.00001f }, 21.3969f };

NJS_CNK_OBJECT object_cart_miles_mod_ = { NJD_EVAL_UNIT_POS | NJD_EVAL_UNIT_ANG | NJD_EVAL_UNIT_SCL | NJD_EVAL_BREAK, &attach_00190A74, 0, 0, 0, 0, 0, 0, 1, 1, 1, NULL, NULL };


Sint32 vertex_0019041C[] = { 0x430022, 0x160000, 0xC0B6DCA8u, 0x3D877158, 0xC08E04EFu, 0xC0B4B083u, 0x3D877158, 0xC10F0514u, 0x40B6DCA8, 0x3D877158, 0xC08E04EFu, 0x40B4B083, 0x3D877158, 0xC10F0514u, 0x0, 0x3D877158, 0xC1279CE8u, 0x0, 0x3D877158, 0xC08E04EFu, 0xC0956914u, 0x3D877158, 0xC0347228u, 0x40956914, 0x3D877158, 0xC0347228u, 0x0, 0x3D877158, 0xC0347228u, 0xC0956914u, 0x3D877158, 0x403B85C2, 0x40956914, 0x3D877158, 0x403B85C2, 0x0, 0x3D877158, 0x403B85C2, 0xC0BF8D49u, 0x3D877158, 0x411EDAC9, 0x40BF8D49, 0x3D877158, 0x411EDAC9, 0x0, 0x3D877158, 0x411EDAC9, 0xC072F1A5u, 0x3D877158, 0x4127D851, 0xC014321Du, 0x3D877158, 0x41638F06, 0x0, 0x3D877158, 0x417600E2, 0x4014321D, 0x3D877158, 0x41638F06, 0x4072F1A5, 0x3D877158, 0x4127D851, 0x0, 0x3D877158, 0x4127D851, 0x0, 0xC2200000u, 0x0, 0xFF, 0x0 };

Sint16 poly_00190320[] = { 0x38, 0x79, 0x28, 0x0, 0x1, 0x15, 0x2, 0x15, 0x3, 0x4, 0x3, 0x15, 0x4, 0x15, 0x1, 0x14, 0xE, 0xF, 0xE, 0xC, 0xF, 0xE, 0x14, 0xD, 0x14, 0x13, 0xD, 0x4, 0x5, 0x3, 0x5, 0x2, 0x3, 0x5, 0x4, 0x0, 0x4, 0x1, 0x0, 0x6, 0x0, 0x15, 0x7, 0x15, 0x2, 0x11, 0x14, 0x10, 0x14, 0xF, 0x10, 0x14, 0x11, 0x13, 0x11, 0x12, 0x13, 0x5, 0x8, 0x2, 0x8, 0x7, 0x2, 0x8, 0x5, 0x6, 0x5, 0x0, 0x6, 0x9, 0x6, 0x15, 0xA, 0x15, 0x7, 0x13, 0x15, 0xD, 0x13, 0x12, 0x15, 0x8, 0xB, 0x7, 0xB, 0xA, 0x7, 0xB, 0x8, 0x9, 0x8, 0x6, 0x9, 0xC, 0x9, 0x15, 0xD, 0x15, 0xA, 0x11, 0x10, 0x15, 0x11, 0x15, 0x12, 0xB, 0xE, 0xA, 0xE, 0xD, 0xA, 0xE, 0xB, 0xC, 0xB, 0x9, 0xC, 0xF, 0x15, 0x10, 0xF, 0xC, 0x15, 0xFF };

NJS_CNK_MODEL attach_00190530 = { vertex_0019041C, poly_00190320, { 0, -19.96693f, 2.449704f }, 23.84099f };

NJS_CNK_OBJECT object_cart_rouge_mod_ = { NJD_EVAL_UNIT_POS | NJD_EVAL_UNIT_ANG | NJD_EVAL_UNIT_SCL | NJD_EVAL_BREAK, &attach_00190530, 0, 0, 0, 0, 0, 0, 1, 1, 1, NULL, NULL };


Sint32 vertex_0019004C[] = { 0xA00022, 0x350000, 0x40BC7A34, 0x3C23E800, 0x408CE642, 0x4079A8A4, 0x3C23E800, 0x408CE643, 0x40BC7A34, 0x3C23E800, 0x41051B2F, 0x4079A8A4, 0x3C23E800, 0x41051B2F, 0x409CA743, 0xC21FF5C2u, 0x40CB8E50, 0xC07CEC05u, 0x3C23E800, 0x408CE642, 0xC0BE1BE4u, 0x3C23E800, 0x408CE643, 0xC07CEC04u, 0x3C23E800, 0x41051B2F, 0xC0BE1BE4u, 0x3C23E800, 0x41051B2F, 0xC09E48F4u, 0xC21FF5C2u, 0x40CB8E50, 0x0, 0xC21FFFFBu, 0xB6880000u, 0x40B6E7A4, 0x0, 0xC092E338u, 0x40A5BACA, 0x0, 0x4002AC9B, 0x40326262, 0x0, 0x40717170, 0x400040D5, 0x0, 0x41103F18, 0x40D00000, 0x0, 0x410CA5A1, 0x40C59999, 0x0, 0x41307CAC, 0x3FA66666, 0x0, 0x4142BA1C, 0xBFA66666u, 0x0, 0x4142BA1C, 0xC0C59999u, 0x0, 0x41307CAC, 0xC0D00000u, 0x0, 0x410CA5A1, 0xC001A1A9u, 0x0, 0x410FE5FE, 0xC0326265u, 0x0, 0x4071716E, 0xC0A70736u, 0x0, 0x400210E4, 0xC0B6F28Au, 0x0, 0xC09239D0u, 0xC0440DC0u, 0x0, 0xC0A3D36Eu, 0xC041BA52u, 0x0, 0xC0B7A3E6u, 0xC0E4CCCAu, 0x0, 0xC0C51B1Bu, 0xC0422896u, 0x0, 0xC10D3622u, 0x40487E30, 0x0, 0xC10C6F10u, 0x40E4CCCC, 0x0, 0xC0C51B19u, 0x4043D7CC, 0x0, 0xC0B86DCCu, 0x40440DC0, 0x0, 0xC0A3D36Eu, 0xC0E4CCC8u, 0x0, 0xC10C2726u, 0x40E4CCCB, 0x0, 0xC10C2726u, 0xBFFBD6FFu, 0x0, 0xC12412A8u, 0x3FFE1E6D, 0x0, 0xC12412A8u, 0xC0C06D53u, 0x0, 0xC10C71FAu, 0xC071A051u, 0x0, 0xC10D054Eu, 0xC0C017DBu, 0x0, 0xC1197F04u, 0xC0715EBBu, 0x0, 0xC1198937u, 0xC0C1CC7Fu, 0x0, 0xC0C1889Au, 0xC071C31Du, 0x0, 0xC0BA176Bu, 0xC071EE9Bu, 0x0, 0xC0AC9C83u, 0xC0C19B8Au, 0x0, 0xC0ACC8BBu, 0x4072E071, 0x0, 0xC10C6335u, 0x40C26DC4, 0x0, 0xC10C3A60u, 0x40C06B53, 0x0, 0xC0C194FDu, 0x40718541, 0x0, 0xC0BAA41Du, 0x4070104F, 0x0, 0xC0ABA282u, 0x40C08A23, 0x0, 0xC0ABE39Eu, 0x40C327A4, 0x0, 0xC11A67EBu, 0x40728066, 0x0, 0xC11A8E3Au, 0xFF, 0x0 };

Sint16 poly_0018FE0C[] = { 0x38, 0x11B, 0x5E, 0x17, 0x18, 0xA, 0x16, 0x17, 0xA, 0x18, 0x19, 0xA, 0x15, 0x16, 0xA, 0x19, 0x1A, 0xA, 0x14, 0x15, 0xA, 0x29, 0x1B, 0xA, 0x13, 0x14, 0xA, 0x27, 0x28, 0xA, 0x28, 0x26, 0xA, 0xA, 0x26, 0x1C, 0x12, 0x13, 0xA, 0x1, 0x0, 0x4, 0x1, 0x3, 0x0, 0x3, 0x2, 0x0, 0x2, 0x3, 0x4, 0x4, 0x0, 0x2, 0x4, 0x3, 0x1, 0x6, 0x5, 0x9, 0x6, 0x8, 0x5, 0x8, 0x7, 0x5, 0x7, 0x8, 0x9, 0x9, 0x5, 0x7, 0x9, 0x8, 0x6, 0x20, 0xB, 0xA, 0xB, 0xC, 0xA, 0x1F, 0x20, 0xA, 0xC, 0xD, 0xA, 0x30, 0x1F, 0xA, 0xD, 0xE, 0xA, 0x22, 0x1E, 0xA, 0xE, 0xF, 0xA, 0x24, 0x1D, 0xA, 0xF, 0x10, 0xA, 0x14, 0x13, 0x15, 0x13, 0x12, 0x15, 0x15, 0x12, 0x16, 0x12, 0x11, 0x16, 0x16, 0x11, 0x17, 0x11, 0x10, 0x17, 0x17, 0x10, 0x18, 0x10, 0xF, 0x18, 0x18, 0xF, 0x19, 0xF, 0xE, 0x19, 0x19, 0xE, 0x1A, 0xE, 0xD, 0x1A, 0x1A, 0xD, 0x2A, 0xD, 0xC, 0x2A, 0x2A, 0xC, 0x2B, 0xC, 0xB, 0x2B, 0x2B, 0xB, 0x2C, 0xB, 0x20, 0x2C, 0x2C, 0x20, 0x29, 0x20, 0x1F, 0x29, 0x29, 0x1F, 0x1B, 0x1F, 0x30, 0x1B, 0x1B, 0x30, 0x21, 0x30, 0x31, 0x21, 0x21, 0x31, 0x25, 0x31, 0x32, 0x25, 0x25, 0x32, 0x27, 0x32, 0x2F, 0x27, 0x27, 0x2F, 0x28, 0x2F, 0x1E, 0x28, 0x28, 0x1E, 0x26, 0x1E, 0x22, 0x26, 0x26, 0x22, 0x1C, 0x22, 0x2E, 0x1C, 0x1C, 0x2E, 0x23, 0x2E, 0x33, 0x23, 0x23, 0x33, 0x24, 0x33, 0x34, 0x24, 0x24, 0x34, 0x1D, 0x34, 0x2D, 0x1D, 0x10, 0x11, 0xA, 0x23, 0x24, 0xA, 0x11, 0x12, 0xA, 0x1C, 0x23, 0xA, 0xA, 0x1D, 0x2D, 0xA, 0x33, 0x2E, 0xA, 0x2E, 0x22, 0xA, 0x1B, 0x21, 0x25, 0x27, 0xA, 0xA, 0x21, 0x25, 0xA, 0x1A, 0x2C, 0x1A, 0x2A, 0x2C, 0x2C, 0x2A, 0x2B, 0xA, 0x2C, 0x29, 0x2D, 0x34, 0xA, 0x34, 0x33, 0xA, 0xA, 0x1E, 0x2F, 0x2F, 0x32, 0xA, 0xA, 0x32, 0x31, 0xA, 0x31, 0x30, 0xFF };

NJS_CNK_MODEL attach_001902D4 = { vertex_0019004C, poly_0018FE0C, { 0, -19.99499f, 0.957941f }, 23.44203f };

NJS_CNK_OBJECT object_cart_mod_ = { NJD_EVAL_UNIT_POS | NJD_EVAL_UNIT_ANG | NJD_EVAL_UNIT_SCL | NJD_EVAL_BREAK, &attach_001902D4, 0, 0, 0, 0, 0, 0, 1, 1, 1, NULL, NULL };


static void
cartDisplayerMod(TASK* tp)
{
    CARTWK* const cwp = GET_CARTWK(tp);

    CAMERA_CONTROL_WORK* const camwk = cameraCurrentWork;

    NJS_POINT3 rel_pos = {
        .x = cwp->pos.x - camwk->campos.x,
        .y = cwp->pos.y - camwk->campos.y,
        .z = cwp->pos.z - camwk->campos.z,
    };

    const float fchk = (rel_pos.x * rel_pos.x) + (rel_pos.y * rel_pos.y) + (rel_pos.z * rel_pos.z);

    if (fchk > 25000000.0f)
        return;

    OnControl3D(NJD_CONTROL_3D_SHADOW | NJD_CONTROL_3D_TRANS_MODIFIER);

    njPushMatrixEx();

    njTranslate(NULL, cwp->pos.x, cwp->pos.y + 0.01f - 2.0f, cwp->pos.z);

    njRotateZ(NULL, cwp->ang.z);
    njRotateX(NULL, cwp->ang.x);
    njRotateY(NULL, cwp->ang.y + cwp->angSlide - 0x8000);

    njRotateZ(NULL, cwp->ang2.z + cwp->ang3.z);
    njRotateX(NULL, cwp->ang2.x + cwp->ang3.x);
    njRotateY(NULL, cwp->ang2.y + cwp->ang3.y);

    switch (cwp->character) {
    case 0:
        njRotateY(NULL, 0x4000);
        njCnkModDrawObject(&object_cart_miles_mod_);
        break;

    case 1:
        njCnkModDrawObject(&object_cart_rouge_mod_);
        break;

    case 2:
    case 3:
    case 4:
    case 5:
    case 6:
    case 7:
        njCnkModDrawObject(&object_cart_mod_);
        break;

    case 8:
        njScale(NULL, 5.0f, 1.0f, 5.0f);
        DrawBasicShadow();
        break;
    }

    njPopMatrixEx();

    OffControl3D(NJD_CONTROL_3D_SHADOW | NJD_CONTROL_3D_TRANS_MODIFIER);
}

#define courseDisplayDisplayer      FuncPtr(void, __cdecl, (TASK*), 0x00623E10)

static hook_info* HookInfoCourseDisplayDisplayer;
static void
courseDisplayDisplayerHook(TASK* tp)
{
    OnControl3D(NJD_CONTROL_3D_SHADOW | NJD_CONTROL_3D_TRANS_MODIFIER);

    FuncHookCall( HookInfoCourseDisplayDisplayer, courseDisplayDisplayer(tp) );

    OffControl3D(NJD_CONTROL_3D_SHADOW | NJD_CONTROL_3D_TRANS_MODIFIER);
}

void* CreateNoStencilTexture();

void
CHS_CartInit()
{
    WriteJump(0x0061CB80, cartDisplayerMod);
    WriteCall(0x0061C60F, CreateNoStencilTexture);

    HookInfoCourseDisplayDisplayer = FuncHook(courseDisplayDisplayer, courseDisplayDisplayerHook);
}
